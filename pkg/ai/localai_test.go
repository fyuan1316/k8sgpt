package ai

import (
	"context"
	"fmt"
	"testing"

	"github.com/sashabaranov/go-openai"
	"github.com/stretchr/testify/assert"
)

func Test_completion(t *testing.T) {
	name := "localai"
	language := "chinese"
	provider := AIProvider{
		Name:    name,
		Model:   "ggml-gpt4all-j",
		BaseURL: "http://localhost:8080/v1",
		Engine:  "localai",
	}

	aiClient := NewClient(name)
	err := aiClient.Configure(&provider, language)
	assert.NoError(t, err)

	r, err := aiClient.GetCompletion(context.TODO(), "Daemonset 是什么?", "")
	assert.NoError(t, err)

	fmt.Println(r)
}

func Test_embd(t *testing.T) {
	name := "localai"
	language := "english"
	provider := AIProvider{
		Name:    name,
		Model:   "ggml-gpt4all-j",
		BaseURL: "http://localhost:8080/v1",
		Engine:  "localai",
	}

	aiClient := NewClient(name)
	err := aiClient.Configure(&provider, language)
	assert.NoError(t, err)

	defaultConfig := openai.DefaultConfig("")
	baseURL := provider.GetBaseURL()
	if baseURL != "" {
		defaultConfig.BaseURL = baseURL
	}

	client := openai.NewClientWithConfig(defaultConfig)
	if client == nil {
		assert.NotNil(t, client, "error creating OpenAI client")
	}

	//input:= []string{"你好，这是一个测试", "Daemonset 时什么?"}
	input := []string{"你好，这是一个测试"}
	resp, err := client.CreateEmbeddings(context.TODO(), openai.EmbeddingRequest{
		Input: input,
		Model: openai.AdaEmbeddingV2,
		User:  "user",
	})
	assert.NoError(t, err)
	fmt.Printf("%v", resp)
	// {list [{embedding [-0.11795609 0.028205039 -0.0025164133 -0.0019693486 0.015087408 -0.0017507318 0.09724801 0.015622794 -0.093384534 -0.048647422 0.025397688 -0.03486698 -0.010393866 -0.0076744556 0.038395412 -0.038935583 0.011260268 -0.047015462 -0.009799574 -0.057340927 -0.096793905 -0.01904165 -0.014895308 -0.020061128 -0.0028741763 0.020993326 0.0009820643 -0.0005132929 -0.025428275 -0.043717064 0.005962096 0.032387216 0.05019979 -0.015368307 0.0025823412 -0.004793393 -0.07021899 -0.022894176 0.051041562 0.02826067 0.024229288 -0.07928099 0.013452633 0.024434874 0.035526972 -0.058556195 0.04131351 0.0133492835 0.07202131 -0.0074818432 -0.0182732 -0.027893096 0.014591183 -0.035414763 0.07032579 -0.0075388174 -0.0234843 0.00023346583 0.03045662 -0.007519751 0.029699406 -0.012982829 -0.14947087 0.07421335 -0.10249944 -0.044451974 0.035981227 -0.020653242 -0.025490833 0.052844338 0.086665414 -0.045512173 -0.0018825592 -0.07955885 0.06544417 0.034560505 0.01687092 0.06003513 0.07608043 0.069926806 -0.019480295 0.02872497 -0.07787719 -0.034995187 0.012101091 0.0015722809 0.05605844 0.0110488655 -0.029209845 0.061743103 -0.0039786594 -0.057946313 0.06069404 -0.006092031 -0.08889918 -0.053505003 0.026078478 -0.018853698 -0.07922309 0.39095205 0.026675845 0.02383114 0.10929373 0.038408585 0.035509042 -0.0796415 -0.05634387 -0.018244416 -0.023201562 0.0379536 -0.043503564 -0.005496773 -0.008268261 0.018332308 0.045915548 0.072248034 -0.010016649 0.031380784 0.07501946 0.0006561136 0.016583553 -0.01826889 -0.031787395 0.063153096 0.045948252 -0.10699601 -0.03151308 -6.3151766e-33 0.030028014 0.0076748007 -0.014107307 -0.015470843 0.043610632 -0.009159392 -0.0028409506 -0.030448621 -0.0048386184 0.06893732 -0.005010202 0.055381667 0.000500064 0.05344287 0.054111283 0.03016852 0.00026068784 0.0017824328 -0.014585561 0.031171653 0.024173768 -0.031416524 0.000699641 0.03680199 -0.028013166 -0.05816782 -0.016928965 -0.04288614 0.02500625 -0.0067494973 -0.011517321 0.0054299543 0.0067254994 -0.0022317038 -0.045679063 -0.019695098 0.050937552 -0.07886983 -0.03779205 0.04944441 -0.04031231 0.0149220545 -0.03820568 -0.02283288 -0.0136245545 0.15463468 -0.02317753 -0.00028497714 -0.03389874 0.06733865 0.020653563 -0.047201246 -0.12173371 0.0140220765 -0.0023958269 0.03963427 -0.006472297 -0.025864989 0.07106053 -0.019228369 0.042951442 0.011863298 0.020946525 -0.011746958 -0.05181096 -0.025221782 0.015916219 0.0047963345 0.09000911 0.025708977 -0.07869134 0.032390047 -8.830134e-05 0.05287343 -0.013753006 -0.025659876 -0.042484973 0.05077731 0.070405684 -0.019269044 0.014168841 -0.0018063794 0.026118506 0.014422769 0.0717146 0.0022959746 -0.04814613 -0.04037386 0.013601751 -0.0741456 -0.076143794 0.06877141 0.02186491 0.08618104 0.017701332 5.275021e-33 -0.0520123 -0.0070530167 -0.021000953 0.068159945 -0.056484006 -0.0007058789 0.039712276 0.13009685 -0.092750795 0.022299115 0.01987774 -0.057888567 0.068668716 0.03879847 -0.021442553 -0.010486337 0.06884485 0.006496405 -0.037182435 -0.04659493 -0.017735783 -0.029052803 -0.013943659 -0.0032787733 -0.019884763 0.04041468 0.02559522 0.028033607 0.037396535 0.02009138 0.044924933 -0.0133506125 -0.07393077 -0.007479466 0.10074588 0.10694269 0.06163493 0.053286344 0.04497569 -0.07861585 0.037282422 0.0003233983 -0.018685034 0.19925244 0.006959399 0.03489903 -0.034186255 0.0028740421 0.017657096 0.106995516 -0.0771095 -0.004531203 -0.03288783 0.029074226 -0.049071305 -0.029799175 -0.011203634 0.0708351 -0.039904643 -0.009588723 -0.007229293 0.02892022 -0.04024974 -0.007472624 -0.018461982 0.030827796 -0.043855432 -0.009039977 -0.058023367 -0.06790988 0.006873392 -0.040279005 -0.09416928 -0.053817973 -0.03185574 -0.03551847 -0.006714314 -0.033570603 -0.013472595 -0.053612456 -0.07335931 0.038533144 -0.029233782 -0.02285164 -0.020307282 0.031225454 -0.019167146 -0.025269574 -0.07197961 0.0089252135 -0.03243137 0.023923656 0.105591506 -0.039851174 0.013971445 -1.3308031e-08 -0.02881266 0.009551061 -0.04310091 0.0013147859 0.0316155 0.038091715 -0.03463586 0.028176717 0.05841591 -0.056158394 0.03203942 -0.0017050564 -0.011090399 0.06556368 0.034713294 -0.0401718 -0.072678186 -0.021365177 0.00022993768 -0.02830506 -0.01724785 -0.07976241 0.010020872 -0.11376146 -0.005467463 -0.0067584566 -0.054050416 0.042325668 0.026303776 -0.0067610196 0.019745985 0.040966872 0.054744646 0.037104953 0.008121472 -0.0381823 -0.046843648 0.024743676 0.01517142 0.021679703 -0.011024753 -0.025643406 0.06287762 -0.0086091105 -0.07367964 0.004504648 0.032039836 0.009045531 -0.0061342996 -0.06694056 -0.05005802 0.022603804 0.0077255243 0.047988456 0.1288198 0.009950001 0.028731614 -0.008990726 0.09112984 -0.0036951227 0.13941547 0.056876533 0.031554446 -0.010137915] 0} {embedding [-0.078869484 -0.007988371 -0.049165286 -0.033156153 -0.036949813 0.013099851 0.08651782 0.036167976 -0.025654038 -0.031196935 0.05190283 0.0074095363 0.026447237 -0.03799152 -0.024103742 -0.035477858 0.027451705 0.014183077 -0.015952537 -0.017069662 -0.06225545 0.0035614704 0.03150908 0.0060411473 -0.051377818 -0.02231313 -0.050775215 -0.05678769 -0.032407157 -0.07648115 -0.010456678 0.07039183 -0.09597222 -0.016330078 -0.0006348376 0.09086719 -0.0010822469 -0.035407085 -0.08112094 0.00712454 0.039261382 0.0035243179 0.023896433 -0.0039860727 -0.043954026 0.011013803 -0.07815007 -0.01421896 0.0028830366 -0.055603 0.013746548 0.0022173438 0.08986753 0.053285107 0.05464914 0.02418194 0.010465776 0.072986536 0.015939578 0.016109869 -0.018140797 0.063930325 -0.04804412 0.048256297 0.05623078 0.02767151 0.021036383 0.008784874 0.037734553 -0.086637184 0.0088029 -0.015737839 0.031967606 0.0037401211 -0.006301013 0.045252025 -0.0056718453 -0.009901722 0.007527014 -0.080226675 -0.087931916 0.036219705 0.0169928 0.010319539 0.009688313 0.076216415 0.03584106 0.059211135 -0.01926737 0.11007607 -0.017242985 0.021197896 0.06671652 -0.036813147 -0.0949952 0.043672375 0.03824875 -0.003729508 -0.030736158 0.12497139 -0.027585557 0.00920557 -0.07528853 0.006439979 -0.013885941 -0.075528905 -0.057741527 -0.054910794 -0.035433892 -0.04223805 -0.036130704 -0.005808393 -0.013054374 0.007062238 0.052805457 0.024022745 -0.045949895 0.04431305 0.01424161 0.01720071 0.044469688 -0.014976932 -0.06206316 -0.0021803833 0.021635557 0.02122682 0.012289381 -2.1435027e-33 0.08366453 -0.0793535 -0.013181306 -0.056643054 0.047546636 -0.020068118 -0.007526027 0.055278696 -0.032090813 0.025605 -0.1076578 0.0372138 -0.02544514 0.010186256 0.040698852 -0.1432257 0.032093953 0.017906742 0.06366166 -0.053393282 -0.016780585 0.13314268 0.012749838 -0.061455365 -0.0051550535 -0.012364963 -0.06843733 -0.002258251 0.05811557 0.06227191 -0.043487556 -0.016994847 0.01198662 0.014189595 -0.0095890965 -0.04107051 -0.05173558 -0.061750136 -0.015681703 -0.04286867 -0.004286275 0.002907625 -0.052346904 0.031771198 -0.045218606 0.021440854 0.025161354 -0.041443318 -0.015802657 0.010607936 0.0017538222 0.03326445 0.064917825 -0.081878096 -0.03348221 0.020160476 -0.0017634401 -0.04709334 0.07052762 0.019305255 0.051163737 0.05055972 0.037786324 -0.026225671 0.048189554 -0.03963975 0.060878705 -0.021400223 0.05799738 0.020389851 -0.003305915 -0.002700502 -0.040772554 0.09554492 0.04431813 0.021909103 -0.006985972 0.05136904 -0.15589479 -0.06386471 -0.021361636 0.04106481 -0.04063925 0.07137309 0.06432679 0.007117406 0.070504434 0.027298644 0.007543705 -0.002880988 -0.07045866 0.0028586325 0.050392736 0.0031734041 -0.1095159 2.2562791e-33 -0.010197848 -0.08635306 -0.018722618 -0.0030193604 0.012922381 0.026196958 -0.02174424 0.044063725 -0.082175344 0.08437347 0.030364908 -0.0051689497 0.054874264 -0.016565457 0.021297658 -0.04056687 -0.071345456 -0.012974304 0.00746453 0.046063725 -0.09858099 -0.0612497 -0.05671235 0.034953363 0.026154704 0.010498646 -0.023168053 0.07854082 -0.13897951 -0.04212457 0.009009356 -0.07625371 -0.06163449 -0.06349758 -0.025850028 0.041007146 0.088962264 0.022119861 -0.10905361 -0.06571009 0.023818241 0.03403129 -0.10330797 0.13777047 0.011561812 0.008086335 -0.05072222 0.028209971 0.04123834 0.093432754 -0.05242276 0.013823034 0.12613538 0.0279337 -0.05637135 -0.06967524 -0.021797102 0.0078828465 0.022749452 0.061842814 0.0900097 -0.112021364 -0.074828565 0.075622775 0.054108188 -0.038721368 -0.018021384 0.08744067 -0.004766152 -0.0070225867 0.09744245 -0.07654327 0.05270814 -0.008810763 -0.0519274 -0.043125734 0.0067461007 -0.14146371 -0.020939043 -0.0039919643 -0.004749303 -0.009573849 -0.026144499 0.034655083 0.005665959 0.011949679 0.05524473 0.022074394 0.019489195 0.0153305875 -0.012079252 -0.0012535657 -0.037578642 0.08529277 -0.04458373 -1.2051703e-08 0.031579234 0.053755928 0.13046297 0.077291235 0.07726207 -0.06549886 0.027929507 0.049793046 -0.059877004 0.029472759 0.016334314 -0.048243567 0.037119176 0.017490117 0.064352095 -0.0009119079 0.04052557 0.10945859 -0.028547082 -0.027735377 -0.003689609 -0.027416654 0.06391943 -0.060203906 -0.009481852 0.020544816 0.07226966 0.003499697 -0.0325214 0.038294308 0.034977514 0.009628511 0.04540969 -0.02798487 0.01188747 0.07902311 -0.1578836 0.04528703 0.030926349 -0.05898189 0.0027017281 0.0019679735 -0.00030311506 0.012317385 -0.01646028 -0.03768493 0.10356227 -0.044936683 0.06251632 -0.0003210926 0.019828608 0.084024675 0.027430013 -0.021414962 0.11222464 0.0011976613 0.065761395 -0.020724457 -0.031206753 0.057181958 -0.006332689 -0.0719314 0.08653967 0.023968646] 1}] text-embedding-ada-002 {0 0 0}}--- PASS: Test_embd (0.37s)
	// {list [{embedding [-0.11795609 0.028205039 -0.0025164133 -0.0019693486 0.015087408 -0.0017507318 0.09724801 0.015622794 -0.093384534 -0.048647422 0.025397688 -0.03486698 -0.010393866 -0.0076744556 0.038395412 -0.038935583 0.011260268 -0.047015462 -0.009799574 -0.057340927 -0.096793905 -0.01904165 -0.014895308 -0.020061128 -0.0028741763 0.020993326 0.0009820643 -0.0005132929 -0.025428275 -0.043717064 0.005962096 0.032387216 0.05019979 -0.015368307 0.0025823412 -0.004793393 -0.07021899 -0.022894176 0.051041562 0.02826067 0.024229288 -0.07928099 0.013452633 0.024434874 0.035526972 -0.058556195 0.04131351 0.0133492835 0.07202131 -0.0074818432 -0.0182732 -0.027893096 0.014591183 -0.035414763 0.07032579 -0.0075388174 -0.0234843 0.00023346583 0.03045662 -0.007519751 0.029699406 -0.012982829 -0.14947087 0.07421335 -0.10249944 -0.044451974 0.035981227 -0.020653242 -0.025490833 0.052844338 0.086665414 -0.045512173 -0.0018825592 -0.07955885 0.06544417 0.034560505 0.01687092 0.06003513 0.07608043 0.069926806 -0.019480295 0.02872497 -0.07787719 -0.034995187 0.012101091 0.0015722809 0.05605844 0.0110488655 -0.029209845 0.061743103 -0.0039786594 -0.057946313 0.06069404 -0.006092031 -0.08889918 -0.053505003 0.026078478 -0.018853698 -0.07922309 0.39095205 0.026675845 0.02383114 0.10929373 0.038408585 0.035509042 -0.0796415 -0.05634387 -0.018244416 -0.023201562 0.0379536 -0.043503564 -0.005496773 -0.008268261 0.018332308 0.045915548 0.072248034 -0.010016649 0.031380784 0.07501946 0.0006561136 0.016583553 -0.01826889 -0.031787395 0.063153096 0.045948252 -0.10699601 -0.03151308 -6.3151766e-33 0.030028014 0.0076748007 -0.014107307 -0.015470843 0.043610632 -0.009159392 -0.0028409506 -0.030448621 -0.0048386184 0.06893732 -0.005010202 0.055381667 0.000500064 0.05344287 0.054111283 0.03016852 0.00026068784 0.0017824328 -0.014585561 0.031171653 0.024173768 -0.031416524 0.000699641 0.03680199 -0.028013166 -0.05816782 -0.016928965 -0.04288614 0.02500625 -0.0067494973 -0.011517321 0.0054299543 0.0067254994 -0.0022317038 -0.045679063 -0.019695098 0.050937552 -0.07886983 -0.03779205 0.04944441 -0.04031231 0.0149220545 -0.03820568 -0.02283288 -0.0136245545 0.15463468 -0.02317753 -0.00028497714 -0.03389874 0.06733865 0.020653563 -0.047201246 -0.12173371 0.0140220765 -0.0023958269 0.03963427 -0.006472297 -0.025864989 0.07106053 -0.019228369 0.042951442 0.011863298 0.020946525 -0.011746958 -0.05181096 -0.025221782 0.015916219 0.0047963345 0.09000911 0.025708977 -0.07869134 0.032390047 -8.830134e-05 0.05287343 -0.013753006 -0.025659876 -0.042484973 0.05077731 0.070405684 -0.019269044 0.014168841 -0.0018063794 0.026118506 0.014422769 0.0717146 0.0022959746 -0.04814613 -0.04037386 0.013601751 -0.0741456 -0.076143794 0.06877141 0.02186491 0.08618104 0.017701332 5.275021e-33 -0.0520123 -0.0070530167 -0.021000953 0.068159945 -0.056484006 -0.0007058789 0.039712276 0.13009685 -0.092750795 0.022299115 0.01987774 -0.057888567 0.068668716 0.03879847 -0.021442553 -0.010486337 0.06884485 0.006496405 -0.037182435 -0.04659493 -0.017735783 -0.029052803 -0.013943659 -0.0032787733 -0.019884763 0.04041468 0.02559522 0.028033607 0.037396535 0.02009138 0.044924933 -0.0133506125 -0.07393077 -0.007479466 0.10074588 0.10694269 0.06163493 0.053286344 0.04497569 -0.07861585 0.037282422 0.0003233983 -0.018685034 0.19925244 0.006959399 0.03489903 -0.034186255 0.0028740421 0.017657096 0.106995516 -0.0771095 -0.004531203 -0.03288783 0.029074226 -0.049071305 -0.029799175 -0.011203634 0.0708351 -0.039904643 -0.009588723 -0.007229293 0.02892022 -0.04024974 -0.007472624 -0.018461982 0.030827796 -0.043855432 -0.009039977 -0.058023367 -0.06790988 0.006873392 -0.040279005 -0.09416928 -0.053817973 -0.03185574 -0.03551847 -0.006714314 -0.033570603 -0.013472595 -0.053612456 -0.07335931 0.038533144 -0.029233782 -0.02285164 -0.020307282 0.031225454 -0.019167146 -0.025269574 -0.07197961 0.0089252135 -0.03243137 0.023923656 0.105591506 -0.039851174 0.013971445 -1.3308031e-08 -0.02881266 0.009551061 -0.04310091 0.0013147859 0.0316155 0.038091715 -0.03463586 0.028176717 0.05841591 -0.056158394 0.03203942 -0.0017050564 -0.011090399 0.06556368 0.034713294 -0.0401718 -0.072678186 -0.021365177 0.00022993768 -0.02830506 -0.01724785 -0.07976241 0.010020872 -0.11376146 -0.005467463 -0.0067584566 -0.054050416 0.042325668 0.026303776 -0.0067610196 0.019745985 0.040966872 0.054744646 0.037104953 0.008121472 -0.0381823 -0.046843648 0.024743676 0.01517142 0.021679703 -0.011024753 -0.025643406 0.06287762 -0.0086091105 -0.07367964 0.004504648 0.032039836 0.009045531 -0.0061342996 -0.06694056 -0.05005802 0.022603804 0.0077255243 0.047988456 0.1288198 0.009950001 0.028731614 -0.008990726 0.09112984 -0.0036951227 0.13941547 0.056876533 0.031554446 -0.010137915] 0}] text-embedding-ada-002 {0 0 0}}--- PASS: Test_embd (0.19s)
}
